name: Release Dofus 2 Main Version

on:
  workflow_dispatch:
    inputs:
      version:
        type: string
        description: The version that will be downloaded
        required: true

jobs:
    build:
        runs-on: self-hosted
        steps:
        -   
            name: System dependencies
            run: sudo apt-get install curl && sudo rm -rf *
        -  
            name: Get doduda
            run: |
                curl -s https://api.github.com/repos/dofusdude/doduda/releases/latest \
                | grep "browser_download_url.*Linux_arm64.tar.gz" \
                | cut -d : -f 2,3 \
                | tr -d \" \
                | wget -qi -
                tar -xzf doduda_Linux_arm64.tar.gz
                chmod +x doduda
        -
            name: Download and parse
            run: |
                mkdir -p persistent
                curl -o persistent/elements.json -L https://raw.githubusercontent.com/dofusdude/doduda/main/persistent/elements.json
                curl -o persistent/item_types.json -L https://raw.githubusercontent.com/dofusdude/doduda/main/persistent/item_types.json
                sudo ./doduda
                sudo ./doduda parse --indent
        -
            name: Group images
            run: |
                tar -czf items_images.tar.gz data/img/item/
                tar -czf mounts_images.tar.gz data/img/mount/

                tar -czf items_images_vector.tar.gz data/vector/item/
                tar -czf mounts_images_vector.tar.gz data/vector/mount/
        - 
            name: Upload release assets
            uses: "marvinpinto/action-automatic-releases@latest"
            with:
              repo_token: "${{ secrets.GITHUB_TOKEN }}"
              prerelease: false
              title: "${{ github.event.inputs.version }}" 
              files: |
                data/*.json
                data/languages/*.json
                items_images.tar.gz
                mounts_images.tar.gz
                items_images_vector.tar.gz
                mounts_images_vector.tar.gz
                
